<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Camp Lip Sync Check-In</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<script defer src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
html{opacity:0;transition:opacity .3s ease-in;font-size:clamp(15px,2vw,18px);}
html.fonts-loaded{opacity:1;}
body{margin:0;min-height:100%;font-family:'Inter',sans-serif;background:black;color:white;
-webkit-user-select:none;touch-action:manipulation;overflow-x:hidden;}
#bg-video{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;opacity:.8;}
.screen{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;
flex-direction:column;padding:2rem 1rem;z-index:10;}
.hidden{opacity:0!important;pointer-events:none;}
.glass-card{background:rgba(0,0,0,.45);backdrop-filter:blur(20px);border-radius:1.25rem;
border:1px solid rgba(255,255,255,.15);width:100%;max-width:460px;overflow:hidden;}
button,select,input{border-radius:.75rem;border:1px solid rgba(255,255,255,.25);
background:rgba(255,255,255,.1);color:white;text-align:center;width:100%;padding:1.1rem;font-size:1.1rem;}
button:hover{background:rgba(255,255,255,.15);}
select{text-align-last:center;-moz-text-align-last:center;}
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video">
  <source src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/mAzP2S1%20-%20Imgur.mp4?alt=media&token=dc264640-a95e-4494-9d27-83ab5380a1a6" type="video/mp4">
</video>

<!-- MAIN SCREEN -->
<div id="main-screen" class="screen">
  <div class="glass-card text-center p-6 shadow-2xl">
    <img src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/EnuWGLA%20-%20Imgur.png?alt=media&token=c06a0ce1-d2e3-4cde-ac4a-a5ba89142b30"
         alt="Camp Lip Sync" class="w-full max-w-[240px] mb-5 mx-auto">
    <h2 class="text-xl font-semibold mb-2">Camp Lip Sync Check-In</h2>
    <p class="text-white/70 text-sm mb-6">Select a session and check-in method below.</p>

    <div class="w-full flex justify-center mb-5">
      <select id="session" class="text-center font-semibold max-w-[260px] text-lg py-3">
        <option value="First Check-In" selected>First Check-In</option>
        <option value="Second Check-In">Second Check-In</option>
        <option value="Final Check-In">Final Check-In</option>
      </select>
    </div>

    <div class="flex flex-col gap-3 mb-5">
      <button id="mode-scan" class="border border-white/40 rounded-lg py-3 text-lg font-semibold">Scan QR / Barcode</button>
      <button id="mode-id" class="border border-white/40 rounded-lg py-3 text-lg font-semibold">Enter Student ID</button>
      <button id="mode-name" class="border border-white/40 rounded-lg py-3 text-lg font-semibold">Check In by Name</button>
    </div>

    <p id="status" class="mt-3 min-h-[2rem] text-base"></p>
    <div id="counts" class="font-semibold text-white">Total Campers Checked In: 0 / 300</div>
  </div>
</div>

<!-- SCANNER -->
<div id="qr-screen" class="screen hidden">
  <div class="glass-card text-center p-6 shadow-2xl">
    <h3 class="text-lg font-semibold mb-4">Scan ID Code</h3>
    <div id="reader" class="w-full max-w-[320px] aspect-square rounded-xl overflow-hidden border border-white/20 mb-4 flex justify-center items-center"></div>
    <button id="stop-scan" class="border border-white/40 rounded-lg py-2 text-base mb-2 w-full">Back</button>
  </div>
</div>

<!-- MANUAL ID -->
<div id="id-screen" class="screen hidden">
  <div class="glass-card text-center p-6 shadow-2xl">
    <h3 class="text-lg font-semibold mb-4">Enter Student ID</h3>
    <input type="text" id="student-id" placeholder="Student ID" class="mb-4 text-lg py-3">
    <button id="submit-id" class="border border-white/40 rounded-lg py-2 text-base mb-3">Submit</button>
    <button id="back-id" class="border border-white/40 rounded-lg py-2 text-base mb-2">Back</button>
    <p id="status-id" class="text-base"></p>
  </div>
</div>

<!-- NAME ENTRY -->
<div id="name-screen" class="screen hidden">
  <div class="glass-card text-center p-6 shadow-2xl">
    <h3 class="text-lg font-semibold mb-4">Check In by Name</h3>
    <input type="text" id="first-name" placeholder="First Name" class="mb-3 text-lg py-3">
    <input type="text" id="last-name" placeholder="Last Name" class="mb-4 text-lg py-3">
    <button id="submit-name" class="border border-white/40 rounded-lg py-2 text-base mb-3">Submit</button>
    <button id="back-name" class="border border-white/40 rounded-lg py-2 text-base mb-2">Back</button>
    <p id="status-name" class="text-base"></p>
  </div>
</div>

<!-- CONFIRMATION -->
<div id="confirm-screen" class="screen hidden">
  <div class="glass-card text-center p-6 shadow-2xl">
    <h3 id="confirm-title" class="text-2xl font-bold mb-3 text-white">✅ Check-In Complete</h3>
    <p id="confirm-name" class="text-white text-base mb-4"></p>
    <button id="confirm-back" class="border border-white/40 rounded-lg py-2 text-base">Back to Check-In</button>
  </div>
</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycbze_aq0FHVeQT-TWKm_5nWzMAx5sl7lmrNNLtJPrmMhYQ7ljKV0aVr3XgxQK3SFLeLG/exec";
let html5QrCode=null;
const statusEl=document.getElementById("status");
const countsEl=document.getElementById("counts");

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  statusEl.textContent="";
}

document.getElementById("mode-scan").onclick=()=>{showScreen("qr-screen");startScanner();};
document.getElementById("mode-id").onclick=()=>showScreen("id-screen");
document.getElementById("mode-name").onclick=()=>showScreen("name-screen");
document.getElementById("confirm-back").onclick=()=>showScreen("main-screen");
document.getElementById("back-id").onclick=()=>showScreen("main-screen");
document.getElementById("back-name").onclick=()=>showScreen("main-screen");

function startScanner(){
  if(html5QrCode)return;
  html5QrCode=new Html5Qrcode("reader");
  const formats=[Html5QrcodeSupportedFormats.QR_CODE,Html5QrcodeSupportedFormats.CODE_128,
                 Html5QrcodeSupportedFormats.CODE_39,Html5QrcodeSupportedFormats.EAN_13];
  html5QrCode.start({facingMode:"environment"},
    {fps:10,qrbox:250,formatsToSupport:formats},
    decoded=>{
      html5QrCode.stop().catch(()=>{});
      html5QrCode=null;
      submitCheckIn({id:decoded});
    },
    ()=>{}
  );
}

document.getElementById("stop-scan").onclick=()=>{
  if(html5QrCode)html5QrCode.stop().catch(()=>{html5QrCode=null;});
  showScreen("main-screen");
};

document.getElementById("submit-id").onclick=()=>{
  const id=document.getElementById("student-id").value.trim();
  if(!id){document.getElementById("status-id").textContent="Please enter an ID.";return;}
  submitCheckIn({id});
};

document.getElementById("submit-name").onclick=()=>{
  const first=document.getElementById("first-name").value.trim();
  const last=document.getElementById("last-name").value.trim();
  if(!first||!last){document.getElementById("status-name").textContent="Enter both first and last name.";return;}
  submitCheckIn({first,last});
};

function submitCheckIn(payload){
  const session=document.getElementById("session").value;
  statusEl.textContent="Submitting check-in...";
  fetch(scriptURL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({...payload,session})
  })
  .then(r=>r.json())
  .then(data=>{
    console.log("Response:",data);
    if(data.message&&data.first&&data.last){
      document.getElementById("confirm-name").textContent=data.first+" "+data.last;
      const title=document.getElementById("confirm-title");
      title.textContent=(session==="Final Check-In")
        ?"✅ Successfully Checked In! Provide Wristband!"
        :"✅ Check-In Complete";
      showScreen("confirm-screen");
      updateCounts(data.counts);
    }else{
      statusEl.textContent=data.message||"Check-in failed.";
    }
  })
  .catch(err=>{
    console.error(err);
    statusEl.textContent="Network error or CORS block. Check deployment settings.";
  });
}

function updateCounts(c){
  if(!c)return;
  countsEl.textContent=`Total Campers Checked In: ${c.Total} / 300`;
}

fetch(scriptURL,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({mode:"count"})
})
.then(r=>r.json())
.then(updateCounts)
.catch(e=>console.error("Count fetch failed:",e));

document.fonts.ready.then(()=>document.documentElement.classList.add('fonts-loaded'));
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Camp Lip Sync Check-In</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<script defer src="https://cdn.tailwindcss.com"></script>
<script>document.fonts.ready.then(()=>document.documentElement.classList.add('fonts-loaded'));</script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

html{opacity:0;transition:opacity .3s ease-in;font-size:clamp(14px,2vw,17px);}
html.fonts-loaded{opacity:1}

body{margin:0;min-height:100%;font-family:'Inter',sans-serif;color:white;background:black;-webkit-user-select:none;touch-action:manipulation;overflow-x:hidden;}
#bg-video{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;z-index:0;opacity:.8;}
.screen{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:2rem 1rem;z-index:10;transition:opacity .3s ease;}
.hidden{opacity:0!important;pointer-events:none;}
.glass-card{background:rgba(0,0,0,.45);backdrop-filter:blur(20px);border-radius:1.25rem;width:100%;max-width:420px;overflow:hidden;padding:2rem;margin-bottom:1.5rem;border:1px solid rgba(255,255,255,.15);}
button.glow{animation:pink-green-glow 6s ease-in-out infinite;}
@keyframes pink-green-glow{0%{box-shadow:0 0 10px 1px rgba(255,105,180,.6);}50%{box-shadow:0 0 18px 3px rgba(96,163,77,.8);}100%{box-shadow:0 0 10px 1px rgba(255,105,180,.6);}}
input, select{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;text-align:center;border-radius:.75rem;width:100%;padding:.75rem;margin-bottom:1rem;}
#checkin-step-select {text-align: center; text-align-last: center; direction: ltr; -moz-text-align-last: center;}
#status,#live-tally{margin-top:1rem;font-size:1.2rem;font-weight:600;min-height:2rem;text-align:center;display:flex;justify-content:center;align-items:center;}
footer img{height:2.5rem;margin-bottom:.5rem;}
@media (prefers-reduced-transparency: reduce){#bg-video{display:none!important;}body{background:radial-gradient(circle at 50% 20%, #111 0%, #000 100%)!important;}.glass-card{background:rgba(0,0,0,0.85)!important;border:1px solid rgba(255,255,255,0.08)!important;backdrop-filter:none!important;}}
</style>
</head>

<body>
<video autoplay muted playsinline loop preload="auto" id="bg-video">
  <source src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/mAzP2S1%20-%20Imgur.mp4?alt=media&token=dc264640-a95e-4494-9d27-83ab5380a1a6" type="video/mp4">
</video>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="screen">
  <div class="glass-card flex flex-col items-center text-center">
    <img class="w-full max-w-[240px] mb-4" src="https://firebasestorage.googleapis.com/v0/b/lip-sync-2025.firebasestorage.app/o/EnuWGLA%20-%20Imgur.png?alt=media&token=c06a0ce1-d2e3-4cde-ac4a-a5ba89142b30" alt="Header">
    <h2 class="text-xl font-semibold mb-4">Camp Check-In</h2>
    <p class="text-white/70 mb-4 text-sm">Scan ID or type it manually.</p>
    <button id="begin-checkin-btn" class="glow w-full py-3 rounded-lg mb-4">Begin Check-In</button>
    <footer class="pt-6 text-white/70 text-sm flex flex-col items-center">
      <img src="https://ik.imagekit.io/cabgcu/Untitled%20design-3.png" alt="CAB Logo">
      <p>Follow Us At <b>@CABGCU</b> On Instagram</p>
    </footer>
  </div>
</div>

<!-- CHECK-IN SCREEN -->
<div id="checkin-screen" class="screen hidden">

  <!-- Live Tally -->
  <div id="live-tally" class="text-center text-lg font-semibold text-white/90 mb-4">
    Checked In: 0
  </div>

  <!-- Scan Step Selection -->
  <div class="glass-card flex flex-col items-center text-center mb-4">
    <h2 class="text-xl font-semibold mb-2">Select Check-In Step</h2>
    <select id="checkin-step-select" class="w-full p-3 rounded-lg mb-2 bg-white/10 border border-white/30 text-white text-center text-base">
      <option value="first">First Check-In</option>
      <option value="second">Second Check-In</option>
      <option value="final">Final Check-In</option>
    </select>
  </div>

  <!-- QR Scanner Card -->
  <div class="glass-card flex flex-col items-center text-center">
    <h2 class="text-xl font-semibold mb-2">Scan Student ID</h2>
    <div id="scanner-container" class="w-full max-w-[320px] h-[320px] border border-white/20 rounded-xl overflow-hidden mb-4"></div>
  </div>

  <!-- Manual Entry Card -->
  <div class="glass-card flex flex-col items-center text-center">
    <h2 class="text-xl font-semibold mb-2">Manual Entry</h2>
    <input type="text" id="manual-id-input" placeholder="Enter Student ID"
      class="w-full p-3 rounded-lg mb-3 bg-white/10 border border-white/30 text-white text-center text-base" />
    <button id="manual-id-btn" class="glow w-full py-3 rounded-lg border border-white/50 text-base text-white mb-0">Submit</button>
  </div>

  <!-- Status message -->
  <div id="status" class="text-white text-base mt-4 min-h-[2rem]"></div>

  <!-- Footer -->
  <footer class="pt-6 text-white/70 text-sm flex flex-col items-center">
    <img src="https://ik.imagekit.io/cabgcu/Untitled%20design-3.png" alt="CAB Logo">
    <p>Follow Us At <b>@CABGCU</b> On Instagram</p>
  </footer>
</div>

<!-- CONFIRMATION SCREEN -->
<div id="confirmation-screen" class="screen hidden">
  <div class="glass-card text-center">
    <h3 class="text-2xl font-bold mb-3 text-white">Check-In Status</h3>
    <p id="confirmation-message" class="text-white text-base mb-4"></p>
    <button id="back-to-checkin" class="glow w-full py-3 rounded-lg">Back to Check-In</button>
  </div>
</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxXMyHVcISOAuSYZwp9gbqDo2fxaEOH3dUZ4oR0eQ306Y-ImZZQzVw5k_4tOUROczw4/exec';
const statusEl = document.getElementById('status');
const tallyEl = document.getElementById('live-tally');
const confirmationEl = document.getElementById('confirmation-message');

function setScreen(id){
  document.querySelectorAll(".screen").forEach(el=>el.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

// Manual entry
document.getElementById('manual-id-btn').addEventListener('click', ()=>{
  const id = document.getElementById('manual-id-input').value.trim();
  const step = document.getElementById('checkin-step-select').value;
  if(!id){statusEl.innerText="Enter Student ID"; return;}
  submitCheckIn(id, step);
  document.getElementById('manual-id-input').value='';
});

// Begin check-in
document.getElementById('begin-checkin-btn').addEventListener('click', ()=>{
  setScreen('checkin-screen');
  startScanner();
});

// Back to check-in
document.getElementById('back-to-checkin').addEventListener('click', ()=>setScreen('checkin-screen'));

// QR Scanner
let html5QrcodeScanner = null;
function startScanner(){
  html5QrcodeScanner = new Html5Qrcode("scanner-container");
  Html5Qrcode.getCameras().then(cameras=>{
    if(cameras && cameras.length){
      html5QrcodeScanner.start(cameras[0].id,{fps:10, qrbox:250},onScanSuccess,onScanFailure);
    }else statusEl.innerText="No camera found";
  }).catch(err=>{
    console.error(err);
    statusEl.innerText="Camera error";
  });
}

function onScanSuccess(decodedText){
  const step = document.getElementById('checkin-step-select').value;
  submitCheckIn(decodedText, step);
}
function onScanFailure(error){}

function submitCheckIn(studentId, step){
  fetch(SHEET_URL,{
    method:'POST',
    body:JSON.stringify({studentId,scan:step}),
    headers:{'Content-Type':'application/json'}
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==='already') statusEl.innerText=`Already scanned for ${capitalize(step)} check-in.`;
    else if(data.status==='first') statusEl.innerText="First scan recorded.";
    else if(data.status==='second') statusEl.innerText="Second scan recorded.";
    else if(data.status==='final') statusEl.innerText="Final check-in complete â€” give wristband.";
    else if(data.status==='missed') statusEl.innerText=data.message;
    else statusEl.innerText=data.message;
    updateTally();
  })
  .catch(err=>{
    console.error(err);
    statusEl.innerText="Error submitting check-in.";
  });
}

function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

// Live tally
async function updateTally(){
  try{
    const res = await fetch(SHEET_URL, { method:'GET' });
    const data = await res.json();
    const checkedIn = data.records ? data.records.filter(r=>r.finalScan).length : 0;
    tallyEl.textContent = `Checked In: ${checkedIn}`;
  }catch(e){console.error(e);}
}
setInterval(updateTally,5000);
updateTally();

// Confirmation screen
function showConfirmation(message){
  confirmationEl.innerText = message;
  setScreen('confirmation-screen');
}
</script>
</body>
</html>
